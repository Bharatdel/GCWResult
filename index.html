<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>GCW Result Viewer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      background: #f2f7fa;
    }
    h1 {
      text-align: center;
      color: #004080;
    }
    select, button {
      font-size: 1rem;
      padding: 0.6rem;
      margin: 0.4rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin-top: 2rem;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: center;
    }
    th {
      background: #dbeaff;
    }
  </style>
</head>
<body>

  <h1>GCW KARNAL â€” Result Viewer</h1>

  <div style="text-align:center;">
    <select id="regnDropdown">
      <option value="">Select Registration No</option>
    </select>
    <button onclick="fetchResult()">Get Result</button>
  </div>

 <div id="resultTable" style="margin-top: 2rem;"></div>
<hr><h2 style="text-align:center;">Category-wise Result Summary</h2>
<div style="text-align:center;">
  <select id="categoryDropdown">
    <option value="">Select Category</option>
  </select>
  <button onclick="fetchCategoryResult()">Get Category Results</button>
</div>

<div id="categoryResultTable" style="margin-top: 2rem;"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

 

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDV9ASRzlNYcOmo6zYNo5_f-svsCJljqbA",
    authDomain: "gcwresult.firebaseapp.com",
    databaseURL: "https://gcwresult-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "gcwresult"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let allResults = {};
  let allPersonal = {};

  // Populate dropdown on page load
  window.onload = async function () {
    populateCategoryDropdown();

    const [resultSnap, personalSnap] = await Promise.all([
      db.ref("Result").once("value"),
      db.ref("Regn_Data").once("value")
    ]);

    allResults = resultSnap.val() || {};
    allPersonal = personalSnap.val() || {};

    const dropdown = document.getElementById("regnDropdown");
    Object.keys(allResults).sort().forEach(regn => {
      const opt = document.createElement("option");
      opt.value = regn;
      opt.textContent = regn;
      dropdown.appendChild(opt);
    });
  };

  function fetchResult() {
    const regn = document.getElementById("regnDropdown").value;
    const output = document.getElementById("resultTable");
    output.innerHTML = "";

    const resultData = allResults[regn];
    const personalData = allPersonal[regn];

    if (!regn || !resultData) {
      output.innerHTML = "<p style='color:red;'>Please select a valid registration number.</p>";
      return;
    }

    // Personal detail column order
    const personalFields = [
      "Regn No", "Student Name", "Fathers Name", "Mothers Name", "Date of Birth",
      "Gender", "Category", "Previous Board", "Passout Year",
      "Previous Exam Roll No", "Previous Exam Total Mark", "Previous Exam Obtained Mark",
      "Student Email Id", "Student Mobile No"
    ];

    // Academic detail fixed order
    const fixedAcademic = ["Semester", "Result Status", "Roll No", "Student Name"];
    const dynamicFields = Object.keys(resultData)
      .filter(key => !fixedAcademic.includes(key) && resultData[key] !== "")
      .sort();

    const finalAcademicCols = fixedAcademic.filter(k => resultData[k] !== "").concat(dynamicFields);

    // ðŸ”· Personal Info Table
    let html = "<h2>Student Personal Details</h2>";
    html += "<table><thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>";

    personalFields.forEach(key => {
      const val = personalData?.[key] || "";
      html += `<tr><td>${key}</td><td>${val}</td></tr>`;
    });

    html += "</tbody></table><br>";

    // ðŸ”¶ Academic Info Table
    html += "<h2>Academic Result</h2><table><thead><tr><th>Regn No</th>";
    finalAcademicCols.forEach(col => html += `<th>${col}</th>`);
    html += "</tr></thead><tbody><tr><td>" + regn + "</td>";

    finalAcademicCols.forEach(col => {
      html += `<td>${resultData[col] || ""}</td>`;
    });

    html += "</tr></tbody></table>";

    output.innerHTML = html;
  }
</script>
<script>
  function populateCategoryDropdown() {
    const categorySet = new Set();
    Object.values(allPersonal).forEach(p => {
      const cat = p?.["Category"]?.trim();
      if (cat) categorySet.add(cat);
    });

    const dropdown = document.getElementById("categoryDropdown");
    categorySet.forEach(cat => {
      const opt = document.createElement("option");
      opt.value = cat;
      opt.textContent = cat;
      dropdown.appendChild(opt);
    });
  }

  function fetchCategoryResult() {
    const category = document.getElementById("categoryDropdown").value;
    const output = document.getElementById("categoryResultTable");
    output.innerHTML = "";

    if (!category) {
      output.innerHTML = "<p style='color:red;'>Please select a category.</p>";
      return;
    }

    let rows = [];
    let passCount = 0;
    let failCount = 0;

    Object.entries(allResults).forEach(([regn, result]) => {
      const person = allPersonal[regn];
      const cat = person?.["Category"]?.trim();

      if (cat === category) {
        const status = (result?.["Result Status"] || "").toLowerCase();
        const isPass = status.includes("pass");
        if (isPass) passCount++; else failCount++;

        rows.push({
          Regn: regn,
          Name: person?.["Student Name"] || "",
          Category: cat,
          RollNo: result?.["Roll No"] || "",
          Result: result?.["Result Status"] || ""
        });
      }
    });

    if (rows.length === 0) {
      output.innerHTML = `<p>No students found in category: <strong>${category}</strong></p>`;
      return;
    }

    let html = `<p><strong>Total Students:</strong> ${rows.length} &nbsp;&nbsp; 
                <strong>Passed:</strong> ${passCount} &nbsp;&nbsp; 
                <strong>Failed:</strong> ${failCount}</p>`;

    html += `<table><thead><tr>
      <th>Regn No</th><th>Roll No</th><th>Student Name</th><th>Category</th><th>Result Status</th>
    </tr></thead><tbody>`;

    rows.forEach(r => {
      const isFail = r.Result.toLowerCase().includes("fail") || r.Result.toLowerCase().includes("re-appear");
      const style = isFail ? ' style="background-color:#ffcccc;font-weight:bold;"' : "";
      html += `<tr${style}><td>${r.Regn}</td><td>${r.RollNo}</td><td>${r.Name}</td><td>${r.Category}</td><td>${r.Result}</td></tr>`;
    });

    html += "</tbody></table>";
    output.innerHTML = html;
  }
</script>

</body>
</html>
